angular.module("nodechat",["ngRoute","luegg.directives"]).config(["$routeProvider","$locationProvider",function(e,t){t.html5Mode(!0),e.when("/home",{templateUrl:"home.tpl.html",controller:"homeCtrl",controllerAs:"ctrl",css:"/views/css/home.css"}).when("/",{templateUrl:"login.tpl.html",controller:"loginCtrl",controllerAs:"ctrl",css:"/views/css/login.css"}).when("/chat/:username",{templateUrl:"chat.tpl.html",controller:"chatCtrl",controllerAs:"ctrl",css:"/views/css/chat.css"}).when("/inbox",{templateUrl:"inbox.tpl.html",controller:"inboxCtrl",controllerAs:"ctrl",css:"/views/css/inbox.css"}).when("/recent",{templateUrl:"recent.tpl.html",controller:"recentCtrl",controllerAs:"ctrl",css:"/views/css/recent.css"}).when("/search",{templateUrl:"search.tpl.html",controller:"searchCtrl",controllerAs:"ctrl",css:"/views/css/search.css"})}]),angular.module("nodechat").controller("chatCtrl",["$routeParams","$route","$rootScope","$scope","chatService","sessionService",function(e,t,r,s,n,a){var o=this;o.currentUser=a.getCurrentUser(),o.chattingTo=e.username,o.newMessage="",o.messageLog=n.getLogForUser(o.chattingTo),o.messageLog&&(o.messages=o.messageLog.messages),n.markAsRead(o.chattingTo),o.sendMessageOnKeypress=function(e){13===e.which&&o.sendMessage()},o.sendMessage=function(){n.sendMessage(o.chattingTo,o.newMessage),o.messageLog||t.reload(),o.newMessage=""}}]),angular.module("nodechat").controller("homeCtrl",["$location","chatService","sessionService",function(e,t,r){var s=this;s.recipient="",s.message="",s.users={},s.currentUser=r.getCurrentUser(),t.getAllUsers().then(function(e){var t=e.data.users;delete t[s.currentUser.username],s.users=t}),s.startChat=function(t){e.path("/chat/"+t.username)},s.userCount=function(){return Object.keys(s.users).length}}]),angular.module("nodechat").controller("inboxCtrl",["$location","chatService",function(e,t){var r=this,s=t.getUnreadMessages();r.unreadMessages=function(){var e={};return angular.forEach(s,function(t,r){e[t.sender]?e[t.sender].push(t):e[t.sender]=[t]}),e}(),r.startChat=function(t){e.path("/chat/"+t)},r.hasUnreadMessages=function(){return 0!==Object.keys(r.unreadMessages).length}}]),angular.module("nodechat").controller("loginCtrl",["$location","$scope","apiService","sessionService",function(e,t,r,s){var n=this;n.user={username:"",gender:"Male",country:"GBR"},n.login=function(){r.addUser(n.user).then(function(t){200===t.status&&t.data.key&&(localStorage.setItem("userKey",t.data.key),s.setKey(t.data.key),s.setCurrentUser(n.user),e.path("/home"))})}}]),angular.module("nodechat").controller("navCtrl",["$location","$route","$rootScope","$scope","chatService","sessionService",function(e,t,r,s,n,a){var o=this;o.unreadMessages=0,o.currentUser=a.getCurrentUser(),o.isHome=function(){return"/home"===e.path()},o.isInbox=function(){return"/inbox"===e.path()},o.isRecent=function(){return"/recent"===e.path()},o.isSearch=function(){return"/search"===e.path()},o.navigateHome=function(){o.isHome()?t.reload():e.path("/home")},o.navigateInbox=function(){o.isInbox()?t.reload():e.path("/inbox")},o.navigateRecent=function(){o.isRecent()?t.reload():e.path("/recent")},o.navigateSearch=function(){o.isSearch()?t.reload():e.path("search")};var c=function(){var e=n.getUnreadMessages();o.unreadMessages=e.length};r.$on("messageLogStateChanged",function(){s.$apply(function(){c()})})}]),angular.module("nodechat").controller("recentCtrl",["$location","chatService",function(e,t){var r=this;r.logs=t.getAllLogs(),r.startChat=function(t){e.path("/chat/"+t)},r.hasActiveChats=function(){return 0!==Object.keys(r.logs).length}}]),angular.module("nodechat").controller("searchCtrl",["$location","chatService","sessionService",function(e,t,r){var s=this;s.users={},s.filteredUsers={},s.searchTerm="",s.isSearchResults=function(){return 0!==Object.keys(s.filteredUsers).length};var n=r.getCurrentUser();t.getAllUsers().then(function(e){var t=e.data.users;delete t[n.username],s.users=t}),s.filterUsers=function(){s.filteredUsers={},angular.forEach(s.users,function(e,t){-1!==t.toLowerCase().indexOf(s.searchTerm.toLowerCase())&&(s.filteredUsers[t]=e)}),""===s.searchTerm&&(s.filteredUsers={})},s.startChat=function(t){e.path("/chat/"+t)}}]),angular.module("nodechat").service("apiService",["$http",function(e){var t=this;BASE_URL="http://nodechatbackend.azurewebsites.net/api",t.addUser=function(t){return e({method:"POST",url:BASE_URL+"/users/add",data:JSON.stringify(t),headers:{"Content-Type":"application/json"}})},t.getAllUsers=function(){return e({method:"GET",url:BASE_URL+"/users/getAll"})}}]),angular.module("nodechat").service("chatService",["$location","$rootScope","sessionService","apiService",function(e,t,r,s){var n=this,a=r.getKey();chatLogs={},n.getAllUsers=function(){return s.getAllUsers()};var o=r.getCurrentUser(),c=io.connect("nodechatbackend.azurewebsites.net",{query:"username="+o.username+"&key="+a});n.sendMessage=function(e,t){c.emit("newChatMessage",{key:a,from:o.username,recipient:e,message:t}),u(o.username,e,t)},n.getLogForUser=function(e){if(i(e))return chatLogs[e]},n.getAllLogs=function(){return chatLogs},c.on("newChatMessage",function(e){u(e.from,o.username,e.message),t.$broadcast("messageLogStateChanged")}),c.on("userDisconnected",function(e){var t=e.username;chatLogs[t]&&delete chatLogs[t]}),n.markAsRead=function(e){i(e)&&angular.forEach(chatLogs[e],function(e,t){angular.forEach(e,function(e,t){e.read=!0})}),t.$broadcast("messageLogStateChanged")},n.getUnreadMessages=function(){var e=[];return angular.forEach(chatLogs,function(t,r){angular.forEach(t.messages,function(t,r){t.read||e.push(t)})}),e};var u=function(t,r,s){var n="",a=!1;r===o.username?(n=t,a=!1):(n=r,a=!0),e.path()==="/chat/"+n&&(a=!0);var c={sender:t,message:s,read:a};i(n)?chatLogs[n].messages.push(c):chatLogs[n]={messages:[c]}},i=function(e){return!!chatLogs[e]}}]),angular.module("nodechat").service("sessionService",function(){var e=this;_key=localStorage.getItem("userKey"),_currentUser={},e.setCurrentUser=function(e){_currentUser=e},e.getCurrentUser=function(){return _currentUser},e.setKey=function(e){_key=e},e.getKey=function(){return _key}});